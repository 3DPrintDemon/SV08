import{m as p,B as u,G as d,P as m,W as g,j as _,n as f}from"./index-2d058d3f.js";import{p as v}from"./vuetify-52f40ce5.js";import"./overlayscrollbars-44d87bcf.js";import"./echarts-9bc570b0.js";var w=Object.defineProperty,b=Object.getOwnPropertyDescriptor,o=(r,e,t,s)=>{for(var i=s>1?void 0:s?b(e,t):e,a=r.length-1,n;a>=0;a--)(n=r[a])&&(i=(s?n(e,t,i):n(i))||i);return s&&i&&w(e,t,i),i};let h=class extends p(u,d){constructor(){super(...arguments),this.refresh=Math.ceil(Math.random()*Math.pow(10,12)),this.isVisible=!0,this.isVisibleDocument=!0,this.isVisibleViewport=!1,this.isLoaded=!0,this.timer=void 0,this.request_start_time=performance.now(),this.start_time=performance.now(),this.time=0,this.request_time=0,this.time_smoothing=.6,this.request_time_smoothing=.1,this.currentFPS=0,this.aspectRatio=null}get webcamStyle(){var t,s,i;const e={transform:this.generateTransform((t=this.camSettings.flip_horizontal)!=null?t:!1,(s=this.camSettings.flip_vertical)!=null?s:!1,(i=this.camSettings.rotation)!=null?i:0),aspectRatio:1.7777777777777777,maxHeight:window.innerHeight-155+"px",maxWidth:"auto"};return this.aspectRatio&&(e.aspectRatio=this.aspectRatio,e.maxWidth=(window.innerHeight-155)*this.aspectRatio+"px"),e}get fpsOutput(){return this.currentFPS<10?"0"+this.currentFPS.toString():this.currentFPS}get showFpsCounter(){var e,t;return this.showFps?!((t=(e=this.camSettings.extra_data)==null?void 0:e.hideFps)!=null&&t):!1}get rotate(){var e;return[90,270].includes((e=this.camSettings.rotation)!=null?e:0)}get url(){var e;return this.convertUrl((e=this.camSettings)==null?void 0:e.snapshot_url,this.printerUrl)}refreshFrame(){this.isVisible&&(this.refresh=new Date().getTime(),this.setFrame())}async setFrame(){let e=new URL(this.url);e.searchParams.append("bypassCache",this.refresh.toString()),this.request_start_time=performance.now(),this.currentFPS=this.time>0?Math.round(1e3/this.time):0;let t=this.$refs.mjpegstreamerAdaptive;if(t){const s=t.getContext("2d"),i=await this.loadImage(e.toString());if(t.width=t.clientWidth,this.rotate?(this.aspectRatio===null&&(this.aspectRatio=i.height/i.width),t.height=t.clientWidth/this.aspectRatio):(this.aspectRatio===null&&(this.aspectRatio=i.width/i.height),t.height=t.clientWidth*this.aspectRatio),this.rotate){const a=t.height/i.width,n=t.width/2,c=t.height/2;s.translate(n,c),s.rotate(this.camSettings.rotation*Math.PI/180),await(s==null?void 0:s.drawImage(i,-i.width/2*a,-i.height/2*a,i.width*a,i.height*a)),s.rotate(-(this.camSettings.rotation*Math.PI/180)),s.translate(-n,-c)}else await(s==null?void 0:s.drawImage(i,0,0,i.width,i.height,0,0,t.width,t.height));this.isLoaded=!0}this.$nextTick(()=>{this.onLoad()})}onLoad(){this.isLoaded=!0;const e=this.camSettings.target_fps||10,t=performance.now(),s=t-this.start_time;this.time=this.time*this.time_smoothing+s*(1-this.time_smoothing),this.start_time=t;const i=1e3/e,a=performance.now()-this.request_start_time;this.request_time=this.request_time*this.request_time_smoothing+a*(1-this.request_time_smoothing);const n=Math.max(0,i-this.request_time);this.$nextTick(()=>{this.timer=setTimeout(this.refreshFrame,n)})}loadImage(e){return new Promise(t=>{let s=new Image;s.onload=()=>t(s),s.onerror=()=>setTimeout(this.refreshFrame,1e3),s.src=e})}mounted(){document.addEventListener("visibilitychange",this.documentVisibilityChanged),this.refreshFrame()}beforeDestroy(){document.removeEventListener("visibilitychange",this.documentVisibilityChanged)}documentVisibilityChanged(){const e=document.visibilityState;this.isVisibleDocument=e==="visible",this.isVisibleDocument||this.stopStream(),this.visibilityChanged()}viewportVisibilityChanged(e){this.isVisibleViewport=e,this.visibilityChanged()}visibilityChanged(){if(this.isVisibleViewport&&this.isVisibleDocument){this.startStream();return}this.stopStream()}startStream(){this.isVisible||(this.isVisible=!0,this.refreshFrame())}stopStream(){this.isVisible=!1,clearTimeout(this.timer),this.timer=void 0}camSettingsChanged(){this.aspectRatio=null}};o([m({required:!0})],h.prototype,"camSettings",2);o([m({default:null})],h.prototype,"printerUrl",2);o([m({default:!0})],h.prototype,"showFps",2);o([g("camSettings",{immediate:!0,deep:!0})],h.prototype,"camSettingsChanged",1);h=o([_],h);var y=function(){var r=this,e=r.$createElement,t=r._self._c||e;return t("div",{staticClass:"d-flex justify-center",staticStyle:{position:"relative"}},[r.isLoaded?r._e():t("div",{staticClass:"text-center py-5"},[t(v,{attrs:{indeterminate:"",color:"primary"}})],1),t("canvas",{directives:[{name:"observe-visibility",rawName:"v-observe-visibility",value:r.viewportVisibilityChanged,expression:"viewportVisibilityChanged"}],ref:"mjpegstreamerAdaptive",class:"webcamImage "+(r.isLoaded?"":"hiddenWebcam"),style:r.webcamStyle,attrs:{width:"600",height:"400"}}),r.isLoaded&&r.showFpsCounter?t("span",{staticClass:"webcamFpsOutput"},[r._v(" "+r._s(r.$t("Panels.WebcamPanel.FPS"))+": "+r._s(r.fpsOutput)+" ")]):r._e()])},S=[];const l={};var C=f(h,y,S,!1,F,"b7397b14",null,null);function F(r){for(let e in l)this[e]=l[e]}const q=function(){return C.exports}();export{q as default};
